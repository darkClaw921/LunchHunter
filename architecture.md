# Архитектура проекта LunchHunter

## Общее описание

LunchHunter — это Telegram-бот для поиска заведений с бизнес-ланчами, кальянами и другими позициями меню. Проект построен на основе асинхронной библиотеки aiogram 3.x и использует SQLite в качестве базы данных (через aiosqlite для асинхронной работы).

## Структура проекта

```
LunchHunter/
├── app/                          # Основной пакет приложения
│   ├── database/                 # Модуль для работы с базой данных
│   │   ├── __init__.py
│   │   └── database.py           # Класс для работы с SQLite
│   ├── handlers/                 # Обработчики команд и колбэков
│   │   ├── __init__.py
│   │   ├── common.py             # Общие обработчики (start, help)
│   │   ├── business_lunch.py     # Обработчики для бизнес-ланчей
│   │   ├── menu_search.py        # Обработчики для поиска по меню
│   │   ├── hookah.py             # Обработчики для поиска кальянов
│   │   └── reviews.py            # Обработчики для отзывов
│   ├── keyboards/                # Клавиатуры для бота
│   │   ├── __init__.py
│   │   └── inline.py             # Инлайн-клавиатуры
│   └── utils/                    # Вспомогательные утилиты
│       ├── __init__.py
│       ├── maps.py               # Утилиты для работы с Яндекс.Картами
│       └── seeder.py             # Скрипт для заполнения БД тестовыми данными
├── main.py                       # Основной файл для запуска бота
├── requirements.txt              # Зависимости проекта
├── .env.example                  # Пример файла с переменными окружения
└── README.md                     # Описание проекта
```

## Детальное описание модулей

### `app/database/database.py`

Содержит класс `Database` для работы с базой данных SQLite. Реализует методы для:
- Создания таблиц
- Добавления и получения информации о заведениях
- Добавления и получения информации о бизнес-ланчах (с учетом дней недели)
- Добавления и получения информации о позициях меню
- Добавления и получения отзывов
- Поиска заведений по различным критериям

### `app/handlers/common.py`

Содержит общие обработчики команд:
- Команда `/start` и `/help` для начала работы с ботом
- Обработчик колбэка для возврата в главное меню
- Обработчик для неизвестных сообщений

### `app/handlers/business_lunch.py`

Обработчики для работы с бизнес-ланчами:
- Отображение списка заведений с бизнес-ланчами на текущий день
- Просмотр детальной информации о заведении
- Пагинация результатов поиска
- Построение маршрута до заведения
- Выбор дня недели для просмотра бизнес-ланчей
- Просмотр всех бизнес-ланчей заведения по дням недели
- Просмотр комментариев администратора и отзывов

### `app/handlers/menu_search.py`

Обработчики для поиска по меню:
- Форма для ввода поискового запроса
- Обработка ввода пользователя и выполнение поиска
- Отображение результатов поиска с пагинацией
- Отображение полной информации о найденных позициях меню

### `app/handlers/hookah.py`

Обработчики для поиска заведений с кальянами:
- Отображение списка заведений с кальянами
- Пагинация результатов поиска
- Отображение полной информации о заведениях

### `app/handlers/reviews.py`

Обработчики для работы с отзывами:
- Форма для оценки заведения (от 1 до 5 звезд)
- Возможность добавления текстового комментария к оценке
- Сохранение отзыва в базе данных
- Просмотр всех отзывов заведения

### `app/keyboards/inline.py`

Функции для создания инлайн-клавиатур:
- Главное меню
- Детальная информация о заведении
- Оценка заведения
- Пагинация результатов
- Отображение результатов поиска
- Выбор дня недели для просмотра бизнес-ланчей
- Просмотр бизнес-ланчей на все дни недели

### `app/utils/maps.py`

Утилиты для работы с геолокацией:
- Формирование ссылки на Яндекс.Карты для построения маршрута

### `app/utils/seeder.py`

Скрипт для заполнения базы данных тестовыми данными:
- Создание тестовых заведений с бизнес-ланчами
- Добавление разных бизнес-ланчей для разных дней недели
- Добавление различных позиций меню
- Добавление тестовых отзывов

### `main.py`

Основной файл для запуска бота:
- Настройка логирования через loguru
- Инициализация базы данных
- Создание экземпляра бота и диспетчера
- Регистрация всех обработчиков
- Запуск поллинга

## Поток данных

1. Пользователь отправляет команду или нажимает кнопку в боте
2. Соответствующий обработчик в модуле `handlers` обрабатывает запрос
3. При необходимости обработчик взаимодействует с базой данных через модуль `database`
4. Обработчик формирует ответ пользователю, используя клавиатуры из модуля `keyboards`
5. Ответ отправляется пользователю

## Особенности реализации бизнес-ланчей по дням недели

1. В таблице `business_lunches` добавлено поле `weekday` для хранения информации о дне недели:
   - 0 - бизнес-ланч доступен каждый день (используется по умолчанию)
   - 1-7 - дни недели (1 - понедельник, 7 - воскресенье)

2. При запросе бизнес-ланчей по умолчанию отображаются ланчи на текущий день недели
   - Сначала ищутся ланчи, специфичные для текущего дня
   - Если таких нет, отображаются ланчи с пометкой "каждый день"

3. Пользователь может выбрать конкретный день недели для просмотра бизнес-ланчей
   - Доступна кнопка "Выбрать день недели" для просмотра меню на другие дни
   - Реализована возможность просмотра всех бизнес-ланчей заведения на разные дни

## Схема базы данных

### Таблица `places`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `name`: TEXT NOT NULL - название заведения
- `address`: TEXT NOT NULL - адрес заведения
- `category`: TEXT NOT NULL - категория заведения
- `photo_id`: TEXT - ID фотографии заведения в Telegram
- `admin_comment`: TEXT - комментарий администратора
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### Таблица `business_lunches`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `weekday`: INTEGER NOT NULL DEFAULT 0 - день недели (0 - каждый день, 1-7 - пн-вс)
- `price`: REAL NOT NULL - цена бизнес-ланча
- `start_time`: TEXT NOT NULL - время начала
- `end_time`: TEXT NOT NULL - время окончания
- `description`: TEXT - описание бизнес-ланча

### Таблица `menu_items`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `name`: TEXT NOT NULL - название позиции меню
- `price`: REAL NOT NULL - цена
- `category`: TEXT NOT NULL - категория (например, "суп", "пиво", "кальян")
- `description`: TEXT - описание позиции меню

### Таблица `reviews`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `user_id`: INTEGER NOT NULL - ID пользователя Telegram
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `rating`: INTEGER NOT NULL - оценка (от 1 до 5)
- `comment`: TEXT - текстовый комментарий
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP 