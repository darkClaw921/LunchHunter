# Архитектура проекта LunchHunter

## Общее описание

LunchHunter — это Telegram-бот для поиска заведений с бизнес-ланчами, кальянами и другими позициями меню. Проект построен на основе асинхронной библиотеки aiogram 3.x и использует SQLite в качестве базы данных (через aiosqlite для асинхронной работы).

## Структура проекта

```
LunchHunter/
├── app/                          # Основной пакет приложения
│   ├── database/                 # Модуль для работы с базой данных
│   │   ├── __init__.py
│   │   └── database.py           # Класс для работы с SQLite
│   ├── handlers/                 # Обработчики команд и колбэков
│   │   ├── __init__.py
│   │   ├── common.py             # Общие обработчики (start, help)
│   │   ├── business_lunch.py     # Обработчики для бизнес-ланчей
│   │   ├── menu_search.py        # Обработчики для поиска по меню
│   │   ├── hookah.py             # Обработчики для поиска кальянов
│   │   ├── reviews.py            # Обработчики для отзывов
│   │   └── admin.py              # Обработчики для администраторов
│   ├── keyboards/                # Клавиатуры для бота
│   │   ├── __init__.py
│   │   └── inline.py             # Инлайн-клавиатуры
│   └── utils/                    # Вспомогательные утилиты
│       ├── __init__.py
│       ├── maps.py               # Утилиты для работы с Яндекс.Картами
│       └── seeder.py             # Скрипт для заполнения БД тестовыми данными
├── main.py                       # Основной файл для запуска бота
├── requirements.txt              # Зависимости проекта
├── .env.example                  # Пример файла с переменными окружения
└── README.md                     # Описание проекта
```

## Детальное описание модулей

### `app/database/database.py`

Содержит класс `Database` для работы с базой данных SQLite. Реализует методы для:
- Создания таблиц
- Добавления и получения информации о пользователях
- Проверки и установки прав администратора
- Добавления и получения информации о заведениях
- Добавления и получения информации о бизнес-ланчах (с учетом дней недели)
- Добавления и получения информации о позициях меню
- Добавления и получения отзывов
- Поиска заведений по различным критериям
- Фильтрации заведений по городам
- Получения списка категорий меню для заведения
- Получения позиций меню по выбранной категории

### `app/handlers/common.py`

Содержит общие обработчики команд:
- Команда `/start` и `/help` для начала работы с ботом
- Запрос города пользователя при первом запуске
- Обработчик для выбора и изменения города
- Обработчик колбэка для возврата в главное меню
- Обработчик для неизвестных сообщений

### `app/handlers/business_lunch.py`

Обработчики для работы с бизнес-ланчами:
- Отображение списка заведений с бизнес-ланчами на текущий день
- Просмотр детальной информации о заведении
- Пагинация результатов поиска
- Построение маршрута до заведения
- Выбор дня недели для просмотра бизнес-ланчей
- Просмотр всех бизнес-ланчей заведения по дням недели
- Просмотр комментариев администратора и отзывов

### `app/handlers/menu_search.py`

Обработчики для поиска по меню:
- Форма для ввода поискового запроса
- Обработка ввода пользователя и выполнение поиска
- Отображение результатов поиска с пагинацией
- Отображение полной информации о найденных позициях меню
- Пагинация между заведениями при поиске
- Кнопки для просмотра всех позиций по запросу
- Просмотр всех категорий меню заведения
- Просмотр позиций меню по выбранной категории

### `app/handlers/hookah.py`

Обработчики для поиска заведений с кальянами:
- Отображение списка заведений с кальянами
- Пагинация результатов поиска
- Отображение полной информации о заведениях

### `app/handlers/reviews.py`

Обработчики для работы с отзывами:
- Форма для оценки заведения (от 1 до 5 звезд)
- Возможность добавления текстового комментария к оценке
- Сохранение отзыва в базе данных
- Просмотр всех отзывов заведения

### `app/handlers/admin.py`

Обработчики для администраторов:
- Добавление новых заведений через команду `/add_place`
- Добавление бизнес-ланчей через команду `/add_lunch`
- Добавление позиций меню через команду `/add_menu`
- Проверка прав администратора через базу данных
- Скрытая команда `/make_admin` для назначения администраторов
- Разделение заведений по городам

### `app/keyboards/inline.py`

Функции для создания инлайн-клавиатур:
- Главное меню
- Выбор города
- Детальная информация о заведении
- Оценка заведения
- Пагинация результатов
- Отображение результатов поиска
- Выбор дня недели для просмотра бизнес-ланчей
- Просмотр бизнес-ланчей на все дни недели
- Пагинация между заведениями при поиске по меню
- Просмотр всех позиций меню по запросу
- Просмотр всех категорий меню заведения
- Просмотр позиций меню по категории

### `app/utils/maps.py`

Утилиты для работы с геолокацией:
- Формирование ссылки на Яндекс.Карты для построения маршрута

### `app/utils/seeder.py`

Скрипт для заполнения базы данных тестовыми данными:
- Создание тестовых пользователей и назначение администраторов
- Создание тестовых заведений с бизнес-ланчами
- Добавление разных бизнес-ланчей для разных дней недели
- Добавление различных позиций меню
- Добавление тестовых отзывов

### `main.py`

Основной файл для запуска бота:
- Настройка логирования через loguru
- Инициализация базы данных
- Создание экземпляра бота и диспетчера
- Регистрация всех обработчиков
- Запуск поллинга

## Поток данных

1. Пользователь отправляет команду или нажимает кнопку в боте
2. При первом запуске бот запрашивает город пользователя
3. Соответствующий обработчик в модуле `handlers` обрабатывает запрос
4. При необходимости обработчик взаимодействует с базой данных через модуль `database`
5. Обработчик формирует ответ пользователю, используя клавиатуры из модуля `keyboards`
6. Ответ отправляется пользователю
7. Все заведения и результаты поиска фильтруются по выбранному городу

## Особенности реализации бизнес-ланчей по дням недели

1. В таблице `business_lunches` добавлено поле `weekday` для хранения информации о дне недели:
   - 0 - бизнес-ланч доступен каждый день (используется по умолчанию)
   - 1-7 - дни недели (1 - понедельник, 7 - воскресенье)

2. При запросе бизнес-ланчей по умолчанию отображаются ланчи на текущий день недели
   - Сначала ищутся ланчи, специфичные для текущего дня
   - Если таких нет, отображаются ланчи с пометкой "каждый день"

3. Пользователь может выбрать конкретный день недели для просмотра бизнес-ланчей
   - Доступна кнопка "Выбрать день недели" для просмотра меню на другие дни
   - Реализована возможность просмотра всех бизнес-ланчей заведения на разные дни

## Особенности реализации разделения по городам

1. При первом запуске бота пользователь выбирает свой город
2. Город сохраняется в базе данных в таблице `users`
3. Все заведения привязаны к конкретному городу через поле `city`
4. Все поисковые запросы фильтруются по городу пользователя
5. Пользователь может изменить свой город через кнопку "Изменить город" в главном меню

## Система администраторов

1. В таблице `users` добавлено поле `is_admin`, которое указывает, является ли пользователь администратором
2. Администраторы имеют доступ к специальным командам:
   - `/add_place` - добавление нового заведения
   - `/add_lunch` - добавление бизнес-ланча с использованием JSON-формата и пагинации заведений
   - `/add_menu` - добавление позиции меню с указанием категории и использованием JSON-формата и пагинации заведений
3. Статус администратора может быть установлен только вручную:
   - Через скрытую команду `/make_admin` (доступна только владельцам бота)
   - Через прямое взаимодействие с базой данных
   - При запуске скрипта заполнения тестовых данных
4. Проверка прав администратора осуществляется через метод `is_admin` в классе `Database`
5. Обычные пользователи не видят и не имеют доступа к административным командам
6. Для команд `/add_lunch` и `/add_menu` реализован удобный выбор заведения с пагинацией
7. Добавление бизнес-ланчей и позиций меню поддерживает JSON-формат для быстрого массового добавления данных

## Формат JSON для добавления бизнес-ланчей

```json
{
  "business_lunch": {
    "time": "12:00 до 15:00",
    "price": 380,
    "days": {
      "понедельник": {
        "positions": ["Салат 'Мимоза'", "Суп с фрикадельками", "Котлета домашняя / картофель"]
      },
      "вторник": {
        "positions": ["Салат 'Коул Слоу'", "Лапша с цыплёнком", "Шницель куриный / картофель"]
      }
    },
    "additional": "Морс + хлеб"
  }
}
```

## Формат JSON для добавления позиций меню

При добавлении позиций меню через команду `/add_menu` сначала запрашивается общая категория для всех добавляемых позиций (например, "напитки", "десерты", "кальяны"), а затем принимается JSON в формате:

```json
{
  "menu_items": [
    {
      "name": "SPATEN",
      "description": "светлый фильтр. лагер",
      "volume": "500 мл",
      "price": 290
    },
    {
      "name": "SPATEN",
      "description": "светлый фильтр. лагер",
      "volume": "300 мл",
      "price": 190
    },
    {
      "name": "HOEGAARDEN",
      "description": "нефильтр. лагер",
      "volume": "500 мл",
      "price": 290
    }
  ]
}
```

Все позиции, указанные в JSON, будут добавлены с категорией, которую ввел администратор.

## Схема базы данных

### Таблица `users`
- `user_id`: INTEGER PRIMARY KEY - ID пользователя Telegram
- `username`: TEXT - имя пользователя в Telegram
- `city`: TEXT NOT NULL - выбранный город пользователя
- `is_admin`: BOOLEAN NOT NULL DEFAULT 0 - статус администратора
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### Таблица `places`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `name`: TEXT NOT NULL - название заведения
- `address`: TEXT NOT NULL - адрес заведения
- `category`: TEXT NOT NULL - категория заведения
- `city`: TEXT NOT NULL - город заведения
- `photo_id`: TEXT - ID фотографии заведения в Telegram
- `admin_comment`: TEXT - комментарий администратора
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP

### Таблица `business_lunches`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `weekday`: INTEGER NOT NULL DEFAULT 0 - день недели (0 - каждый день, 1-7 - пн-вс)
- `price`: REAL NOT NULL - цена бизнес-ланча
- `start_time`: TEXT NOT NULL - время начала
- `end_time`: TEXT NOT NULL - время окончания
- `description`: TEXT - описание бизнес-ланча

### Таблица `menu_items`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `name`: TEXT NOT NULL - название позиции меню
- `price`: REAL NOT NULL - цена
- `category`: TEXT NOT NULL - категория (например, "суп", "пиво", "кальян")
- `description`: TEXT - описание позиции меню

### Таблица `reviews`
- `id`: INTEGER PRIMARY KEY AUTOINCREMENT
- `user_id`: INTEGER NOT NULL - ID пользователя Telegram
- `place_id`: INTEGER NOT NULL - ID заведения (внешний ключ)
- `rating`: INTEGER NOT NULL - оценка (от 1 до 5)
- `comment`: TEXT - текстовый комментарий
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP 